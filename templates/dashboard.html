<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>総務部　姿勢ルールチェック</title>
<style>
html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    background-color: #f5f6fa;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.table-wrapper {
    display: flex;
    flex-direction: column;
    height: 99%;
    margin: 0 auto;
    border-radius: 12px;
    overflow: hidden;
}

body.day-view .table-wrapper { width: 50%; }
body.week-view .table-wrapper,
body.month-view .table-wrapper { width: 95%; }

h2 {
    margin: 20px 0;
    padding: 10px 20px;
    text-align: center;
    font-weight: 700;
    font-size: 1.8rem;
    color: #fff;
    background: linear-gradient(90deg, #6c5ce7, #00cec9);
    border-radius: 12px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.header-links {
    display: flex;
    gap: 10px;
    margin-bottom: 5px;
}
.header-links a { text-decoration: none; color: #3498db; }

.header-links-bottom {
    display: flex;
    gap: 10px;
    margin-bottom: 5px;
}
.header-links-bottom a { text-decoration: none; color: #3498db; }
.header-links-bottom a.logout { margin-left: auto; }

.table-container {
    flex: 1 1 auto;
    overflow: auto;
    background-color: #fff;
    border-radius: 12px;
}

table { 
    border-collapse: collapse; 
    width: 100%; 
    white-space: nowrap; 
}

th, td { 
    border: 1px solid #ddd; 
    text-align: center; 
    vertical-align: middle;
    padding: 4px 6px;
}

th { 
    background: linear-gradient(to bottom, #6c5ce7, #a29bfe);
    color: #fff;
    font-weight: bold;
    position: sticky; 
    top: 0; 
    z-index: 3; 
    line-height: 1.2; 
}

th:first-child, td:first-child {
    position: sticky;
    left: 0;
    background-color: #fff;
    z-index: 2;
    background-clip: padding-box; 
}

thead th:first-child { z-index: 4; }

.group-row td {
    background-color: #dcdde1;
    font-weight: bold;
    text-align: left;
    padding-left: 10px;
    font-size: 1rem;
    height: auto; 
}

.user-row td { 
    background-color: #f1f2f6; 
    text-align: left; 
    font-weight: bold; 
    padding-left: 20px;
    font-size: 0.95rem;
    height: auto; 
}

td.task-name {
    text-align: left;
    padding-left: 40px;
    height: auto; 
}

.status-btn {
    width: 30px;
    height: 24px;
    font-size: 0.8rem;
    border: none;
    cursor: pointer;
    border-radius: 6px;
    color: #fff;
    font-weight: bold;
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 0 auto;
}

.status-0 { background-color: #e74c3c; }
.status-1 { background-color: #2980b9; }
.status-2 { background-color: #f1c40f; color: #000; }
.status-btn:disabled { background-color: #ccc; color: #666; cursor: not-allowed; }

.today-col { background-color: #fff9c4; }

/* --- レスポンシブ対応 --- */
@media (max-width: 768px) {
    .table-wrapper { width: 100% !important; padding: 0 5px; }
    h2 { font-size: 1.4rem; padding: 8px 10px; }
    .header-links, .header-links-bottom {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
        font-size: 0.9rem;
    }
    .header-links a, .header-links-bottom a { font-size: 0.85rem; margin-right: 5px; }
    table th, table td { padding: 3px 4px; font-size: 0.75rem; }
    td.task-name { padding-left: 20px; }
    .status-btn { width: 24px; height: 20px; font-size: 0.7rem; }
    .table-container { overflow-x: auto; }
}

@media (max-width: 480px) {
    h2 { font-size: 1.2rem; padding: 6px 8px; }
    table th, table td { padding: 2px 3px; font-size: 0.7rem; }
    td.task-name { padding-left: 15px; }
    .status-btn { width: 20px; height: 18px; font-size: 0.6rem; }
    .header-links, .header-links-bottom { font-size: 0.75rem; }
}
</style>
</head>
<body class="{{ view_mode }}-view">

<div class="table-wrapper">

<h2 align="center">総務部　姿勢ルールチェック</h2>

<!-- 上段：日・週・月切替 -->
<div class="header-links" style="display: flex; justify-content: space-between; align-items: center;">
    <div>
        <a href="{{ url_for('dashboard', view='day') }}">日表示</a>
        <a href="{{ url_for('dashboard', view='week') }}">週表示</a>
        <a href="{{ url_for('dashboard', view='month') }}">月表示</a>
    </div>
    <div>
        <a href="{{ url_for('monthly_report', year=current_year, month=current_month) }}">月間レポート</a>
    </div>
</div>

<!-- 下段：前日/翌日 / 前週/次週 / 前月/次月 + ログアウト -->
<div class="header-links-bottom">
    {% if view_mode == 'day' %}
        <a href="{{ url_for('dashboard', view='day', week=prev_link) }}">前日</a>
        <a href="{{ url_for('dashboard', view='day', week=next_link) }}">翌日</a>
    {% elif view_mode == 'week' %}
        <a href="{{ url_for('dashboard', view='week', week=prev_link) }}">前週</a>
        <a href="{{ url_for('dashboard', view='week', week=next_link) }}">次週</a>
    {% else %}
        <a href="{{ url_for('dashboard', view='month', week=prev_link) }}">前月</a>
        <a href="{{ url_for('dashboard', view='month', week=next_link) }}">次月</a>
    {% endif %}
    <a href="{{ url_for('logout') }}" class="logout">ログアウト</a>
</div>

<div class="table-container">
<table>
<thead>
<tr>
    <th></th>
    {% for day in days %}
    <th class="{% if day == today %}today-col{% endif %}">
        {{ day.strftime("%m/%d") }}<br>
        {% set weekday = day.weekday() %}
        {% if weekday == 0 %}月{% elif weekday == 1 %}火{% elif weekday == 2 %}水{% elif weekday == 3 %}木
        {% elif weekday == 4 %}金{% elif weekday == 5 %}土{% else %}日{% endif %}
    </th>
    {% endfor %}
</tr>
</thead>
<tbody>
{% if groups %}
    {% for group, users_in_group in groups.items() %}
    <tr class="group-row">
        <td>{{ group }}</td>
        {% for day in days %}<td class="{% if day == today %}today-col{% endif %}"></td>{% endfor %}
    </tr>
    {% for user in users_in_group %}
    <tr class="user-row">
        <td>{{ user.name }}</td>
        {% for day in days %}<td class="{% if day == today %}today-col{% endif %}"></td>{% endfor %}
    </tr>
    {% set user_tasks = tasks_by_user.get(user.userid, []) %}
    {% if user_tasks %}
        {% for task in user_tasks %}
        <tr>
            <td class="task-name">{{ task.name }}</td>
            {% for day in days %}
            {% set status = status_dict.get(task.taskkey, {}).get(day, 0) %}
            <td class="{% if day == today %}today-col{% endif %}">
                <button type="button" class="status-btn status-{{ status }}"
                        data-task="{{ task.taskkey }}"
                        data-day="{{ day.isoformat() }}"
                        {% if day > today or day < system_start_date %}disabled{% endif %}>
                    {% if status == 0 %}未{% elif status == 1 %}済{% else %}休{% endif %}
                </button>
                <input type="hidden" name="task_{{ task.taskkey }}_{{ day.isoformat() }}" id="hidden_{{ task.taskkey }}_{{ day.isoformat() }}" value="{{ status }}">
            </td>
            {% endfor %}
        </tr>
        {% endfor %}
    {% else %}
        <tr>
            <td class="task-name">未登録タスク</td>
            {% for day in days %}
            <td class="{% if day == today %}today-col{% endif %}">
                <button type="button" class="status-btn status-0" disabled>未</button>
                <input type="hidden" name="task_dummy_{{ day.isoformat() }}" value="0">
            </td>
            {% endfor %}
        </tr>
    {% endif %}
    {% endfor %}
    {% endfor %}
{% else %}
<tr>
    <td>未登録グループ/ユーザー</td>
    {% for day in days %}
    <td class="{% if day == today %}today-col{% endif %}">
        <button type="button" class="status-btn status-0" disabled>未</button>
    </td>
    {% endfor %}
</tr>
{% endif %}
</tbody>
</table>
</div>

<script>
document.querySelectorAll('.status-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
        if (btn.disabled) return;
        let current = btn.classList.contains('status-0') ? 0 : btn.classList.contains('status-1') ? 1 : 2;
        let next = (current + 1) % 3;
        btn.classList.remove('status-0','status-1','status-2');
        btn.classList.add('status-'+next);
        btn.textContent = next==0?'未':next==1?'済':'休';
        let hidden = document.getElementById(`hidden_${btn.dataset.task}_${btn.dataset.day}`);
        if(hidden) hidden.value = next;
        try{
            const res = await fetch("/update_status",{
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body:JSON.stringify({taskkey:btn.dataset.task,day:btn.dataset.day,status:next})
            });
            const result = await res.json();
            if(!result.success){
                alert("保存エラー:"+ (result.error||""));
                btn.classList.remove('status-0','status-1','status-2');
                btn.classList.add('status-'+current);
                btn.textContent = current==0?'未':current==1?'済':'休';
                if(hidden) hidden.value = current;
            }
        }catch(err){
            alert("通信エラー:"+err);
            btn.classList.remove('status-0','status-1','status-2');
            btn.classList.add('status-'+current);
            btn.textContent = current==0?'未':current==1?'済':'休';
            if(hidden) hidden.value = current;
        }
    });
});
</script>

</div>
</body>
</html>
