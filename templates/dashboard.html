<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>総務部　姿勢ルールチェック</title>
<style>
html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    background-color: #f5f6fa;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.table-wrapper {
    width: 95%; 
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    height: 100%;
}

h2 {
    margin: 0 0 5px 0;
    color: #2f3640;
}

.header-links {
    display: flex;
    gap: 10px;
    margin-bottom: 5px;
}
.header-links a {
    text-decoration: none;
    color: #3498db;
}

.header-links-bottom {
    display: flex;
    gap: 10px;
    margin-bottom: 5px;
}
.header-links-bottom a {
    text-decoration: none;
    color: #3498db;
}
.header-links-bottom a.logout {
    margin-left: auto;
}

.table-container {
    flex: 1 1 auto;
    overflow: auto;
    background-color: #fff;
}

/* テーブル */
table { 
    border-collapse: collapse; 
    width: 100%; 
    white-space: nowrap; 
}

th, td { 
    border: 1px solid #ddd; 
    text-align: center; 
    vertical-align: middle;
    padding: 4px 6px;
}

/* ヘッダー固定 */
th { 
    background: linear-gradient(to bottom, #6c5ce7, #a29bfe);
    color: #fff;
    font-weight: bold;
    position: sticky; 
    top: 0; 
    z-index: 3; 
    line-height: 1.2; /* 高さを揃える */
}

/* 左端列固定（グループ・ユーザ・タスク名） */
th:first-child, td:first-child {
    position: sticky;
    left: 0;
    background-color: #fff;
    z-index: 2;
    background-clip: padding-box; /* 下線のずれ防止 */
}

/* 左上角優先表示 */
thead th:first-child {
    z-index: 4;
}

/* グループ行 */
.group-row td {
    background-color: #dcdde1;
    font-weight: bold;
    text-align: left;
    padding-left: 10px;
    font-size: 1rem;
    height: auto; /* 高さ自動 */
}

/* ユーザー行 */
.user-row td { 
    background-color: #f1f2f6; 
    text-align: left; 
    font-weight: bold; 
    padding-left: 20px;
    font-size: 0.95rem;
    height: auto; /* 高さ自動 */
}

/* タスク行インデント */
td.task-name {
    text-align: left;
    padding-left: 40px;
    height: auto; /* 高さ自動 */
}

/* ステータスボタン */
.status-btn {
    width: 30px;
    height: 24px;
    font-size: 0.8rem;
    border: none;
    cursor: pointer;
    border-radius: 6px;
    color: #fff;
    font-weight: bold;
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 0 auto;
}

.status-0 { background-color: #e74c3c; }
.status-1 { background-color: #2980b9; }
.status-2 { background-color: #f1c40f; color: #000; }
.status-btn:disabled {
    background-color: #ccc;
    color: #666;
    cursor: not-allowed;
}
</style>
</head>
<body>

<div class="table-wrapper">

<h2 align="center">総務部　姿勢ルールチェック</h2>

<!-- 上段：週/月切替 -->
<div class="header-links">
    <a href="{{ url_for('dashboard', view='week') }}">週表示</a>
    <a href="{{ url_for('dashboard', view='month') }}">月表示</a>
</div>

<!-- 下段：前週/次週 + ログアウト右端 -->
<div class="header-links-bottom">
    {% if view_mode == 'week' %}
        <a href="{{ url_for('dashboard', view='week', week=prev_week) }}">前週</a>
        <a href="{{ url_for('dashboard', view='week', week=next_week) }}">次週</a>
    {% else %}
        <a href="{{ url_for('dashboard', view='month', week=prev_week) }}">前月</a>
        <a href="{{ url_for('dashboard', view='month', week=next_week) }}">次月</a>
    {% endif %}
    <a href="{{ url_for('logout') }}" class="logout">ログアウト</a>
</div>

<div class="table-container">
<table>
<thead>
<tr>
    <th>グループ / ユーザー / タスク</th>
    {% for day in days %}
    <th>
        {{ day.strftime("%m/%d") }}<br>
        {% set weekday = day.weekday() %}
        {% if weekday == 0 %}月{% elif weekday == 1 %}火{% elif weekday == 2 %}水{% elif weekday == 3 %}木
        {% elif weekday == 4 %}金{% elif weekday == 5 %}土{% else %}日{% endif %}
    </th>
    {% endfor %}
</tr>
</thead>
<tbody>
{% for group, users_in_group in groups.items() %}
<tr class="group-row">
    <td>{{ group }}</td>
    {% for day in days %}<td></td>{% endfor %}
</tr>
{% for user in users_in_group %}
<tr class="user-row">
    <td>{{ user.name }}</td>
    {% for day in days %}<td></td>{% endfor %}
</tr>
{% for task in tasks if task.user_id == user.userid %}
<tr>
    <td class="task-name">{{ task.name }}</td>
    {% for day in days %}
    <td>
        {% set status = status_dict.get(task.taskkey, {}).get(day, 0) %}
        <button type="button" class="status-btn status-{{ status }}" data-task="{{ task.taskkey }}" data-day="{{ day.isoformat() }}" {% if day > today %}disabled{% endif %}>
            {% if status == 0 %}未{% elif status == 1 %}済{% else %}休{% endif %}
        </button>
        <input type="hidden" name="task_{{ task.taskkey }}_{{ day.isoformat() }}" id="hidden_{{ task.taskkey }}_{{ day.isoformat() }}" value="{{ status }}">
    </td>
    {% endfor %}
</tr>
{% endfor %}
{% endfor %}
{% endfor %}
</tbody>
</table>
</div>

<script>
// ステータスボタンクリック処理（既存のまま）
document.querySelectorAll('.status-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
        if (btn.disabled) return;
        let current = btn.classList.contains('status-0') ? 0 : btn.classList.contains('status-1') ? 1 : 2;
        let next = (current + 1) % 3;
        btn.classList.remove('status-0','status-1','status-2');
        btn.classList.add('status-'+next);
        btn.textContent = next==0?'未':next==1?'済':'休';
        let hidden = document.getElementById(`hidden_${btn.dataset.task}_${btn.dataset.day}`);
        if(hidden) hidden.value = next;
        try{
            const res = await fetch("/update_status",{
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body:JSON.stringify({taskkey:btn.dataset.task,day:btn.dataset.day,status:next})
            });
            const result = await res.json();
            if(!result.success){
                alert("保存エラー:"+ (result.error||""));
                btn.classList.remove('status-0','status-1','status-2');
                btn.classList.add('status-'+current);
                btn.textContent = current==0?'未':current==1?'済':'休';
                if(hidden) hidden.value = current;
            }
        }catch(err){
            alert("通信エラー:"+err);
            btn.classList.remove('status-0','status-1','status-2');
            btn.classList.add('status-'+current);
            btn.textContent = current==0?'未':current==1?'済':'休';
            if(hidden) hidden.value = current;
        }
    });
});
</script>

</div>
</body>
</html>
